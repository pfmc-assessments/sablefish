```{r executive, echo = FALSE}
executive <- list()
executive[["stock"]] <- paste0("This assessment update reports the status of ",
  spp, " (_", spp.sci, "_) off the ", coast, 
  " using data through 2022.")
```


# Executive summary{-}

## Stock{-}

`r executive[["stock"]]` The resource is modeled as a single stock; however, `r spp` disperse to and from offshore seamounts, along the coastal waters of the U.S. West Coast, Canada, and Alaska, and across the Aleutian Islands to the western Pacific. This potential movement is not explicitly accounted for in this analysis.

## Landings and catches{-}

The earliest landings of `r spp` off the West Coast used within in this assessment begin in `r startyr`. The landings begun to slowly increase starting in the 1920s and continued at a roughly constant level until the 1970s where landings sharply increased peaking in the late 1970s (Figure \@ref(fig:es-landings)). After peaking in the late 1970s, catches slowly decreased across the time series until the 2000s when catches generally stabilized. Fishery landings have been divided among two coastwide fleets: a fixed gear and a trawl fleet (see Table \@ref(tab:es-landings) for the most recent ten years). The assessment update estimates annual discard mortality by fleet informed by data from the \glsentrylong{wcgop} and other historical discarding studies. This internal estimation can result in model estimates of catches (landings plus discards) that differ between stock assessments, even when the input landings remain unchanged, due to changes in fixed and estimated parameter values, priors, or parameterizations. 

The landings in this assessment update were minimally revised and corrected from those used 2019 benchmark and the 2021 update assessments. First, landings from the `Oregon Coast' \glsentrylong{inpfc} area, i.e., between 42.000--46.267\textdegree N. latitude, are no longer excluded from the total landings. Second, landings from 1977--1982 in the catch reporting area that includes both U.S. and Canadian waters are now assigned 50--50\% to each country rather than 100\% to the U.S. Third, a time series of `r spp` catches from the At-Sea Pacific Hake fishery are now included in the trawl fleet. Previous assessments have included bycatch of `r spp` from the shoreside fleet but these at-sea catches were previously only included as a sensitivity. 

```{r, results = "asis"}

tab <- model$timeseries[model$timeseries$Yr %in% (endyr-9):endyr, 
                        c("Yr", "retain(B):_1", "retain(B):_2", "dead(B):_1", "dead(B):_2")]
df <- data.frame(
  Year = tab[,"Yr"],
  Fixed_Gear = tab[,"retain(B):_1"],
  Trawl = tab[, "retain(B):_2"],
  Landings = tab[, "retain(B):_1"] + tab[, "retain(B):_2"],
  Catch = tab[, "dead(B):_1"] + tab[, "dead(B):_2"]
)
sa4ss::table_format(
  x = df,
  caption = "Landings (mt) by fleet and the summed coastwide total landings and estimated total catch.",
  label = "es-landings",
  digits = 1,
  align = "l",
  # to do: use a renamer between fleet number and name
  col_names = c("Year", "Fixed Gear Landings", "Trawl Landings", "Total Landings", "Total Catch")
)
```


```{r, results = "asis"}
sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "catch2 landings stacked.png"
  ),
  caption = "Landings by year from the fixed gear (FIX) and trawl (TWL) fleets.",
  alt_caption = "",
  label = "es-landings"
)
```


## Data and assessment{-}

The last benchmark stock assessment for sablefish took place during 2019 [@haltuch_status_2019b], followed by an update assessment conducted in 2021 [@Kapur:2021:SSA].  This assessment update uses the stock assessment framework \gls{ss3} version `r ss3_version[["current"]]`. Primary data sources include fishery landings and age-composition data from the retained catch. Only the fishery landings were re-evaluated for this assessment update and extended through `r endyr`.  Recent years data, 2020--2021, on the discarded portion of commercial catch, including discard lengths, rates, and mean observed individual body weight of the discarded catch were included in this analysis. The relative index of abundance estimated from the Northwest Fisheries Science Center (NWFSC) West Coast Groundfish Bottom Trawl (WCGBT) survey, which samples depths from 55 - 1,280 m, represents the primary source of information on the stock’s trend and was updated and re-analyzed to include the most recent data, covering the period 2003--`r endyr`. Other, discontinued, survey indices contribute information on trend and sablefish demographics: (a) NWFSC Slope Survey conducted from 1998-2002, (b) Alaska Fisheries Science Center (AFSC) Slope Survey (1997-2001), and (c) AFSC/NWFSC Triennial Shelf Survey (1980-2004). Data from the historical surveys were not re-evaluated for this assessment update. Additionally, an environmental time-series of sea level was used as a survey index of recruitment in the base model; this time-series was updated and re-analyzed using the latest tide gauge data.

All externally estimated model parameters, (a) weight-length relationship, (b) maturity schedule, and (c) fecundity relationships remained unchanged from the 2019 benchmark assessment. As in previous assessments, growth and natural mortality were estimated using sex-specific relationships. Uncertainty in recruitment was included by estimating a full time-series of deviations from the stock-recruitment curve. The ‘one-way-trip’ nature of the time-series does not facilitate estimation of the steepness parameter ($h$) of the stock-recruitment relationship. Therefore, $h$ was fixed at 0.7, similar to values used on other groundfish stock assessments, and was explored via sensitivity analysis in 2019; and information regarding $h$ is explored in this analysis via likelihood profiles.

## Stock biomass and dynamics{-}

During the first half of the 20th century it is estimated that `r spp` were exploited at relatively modest levels. Modest catches continued until the 1960s, along with a higher frequency of above average, but uncertain, estimates of recruitment through the 1970s. The spawning biomass increased during the mid-1950s to mid-1970s (Figure \@ref(fig:es-sb)). Subsequently, spawning biomass is estimated to have declined between the mid-1970s and the early 2010s, with the largest harvests occurring during the 1970s followed by harvests that were, on average, higher than pre-1970s harvest through the early 2000s. In recent years, the spawning biomass is estimated to be increasing due to strong recruitment events in 2013 and 2016 (Table \@ref(tab:ssbES)). Although the relative trend in spawning biomass is robust to uncertainty in the leading model parameters, the productivity of the stock is uncertain due to confounding of natural mortality, absolute stock size, and productivity. The estimates of uncertainty around the point estimate of stock size in `r endyr+1` are large, suggesting that the spawning biomass could range from just under `r format(round(sb_lci, digits = 0))` mt to `r format(round(sb_uci,0))` mt.  

The estimated relative stock trajectory across the times series is highly variable, with the population increasing to near unfished levels in the 1970s, declining to at or near the target relative biomass of 40% around 2000, and then increasing at the end of the modeled period (Table \@ref(tab:ssbES) and Figure \@ref(fig:es-depl)). The estimated fraction unfished in `r endyr+1` from the base model is `r  round(model$derived_quants[grep('Bratio_2023', model$derived_quants$Label),'Value']*100, 1)`% (95\% confidence interval `r round(bratio_lci*100, 1)`%--`r round(bratio_uci*100, 1)`%) increasing from the estimated fraction unfished in 2021 of 58% [@Kapur:2021:SSA].


\input{52tables/b_SSB_ES.tex}


```{r, results = "asis"}
sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "ts7_Spawning_biomass_(mt)_with_95_asymptotic_intervals_intervals.png"
  ),
  caption = "Estimated time series of spawning output (circles and line: median; light broken lines: 95 percent intervals) for the base model",
  alt_caption = "",
  label = "es-sb"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "ts9_Relative_spawning_biomass_intervals.png"
  ),
  caption = "Estimated time series of fraction of unfished spawning output (circles and line: median; light broken lines: 95 percent intervals) for the base model",
  alt_caption = "",
  label = "es-depl"
)
```

\newpage

## Recruitment{-}

`r Spp` recruitment is estimated to be quite variable with large amounts of uncertainty in individual recruitment events. A period with generally higher frequencies of strong recruitments spans from the early 1950s through the 1970s, followed by a lower frequency of large recruitments during 1980 forward, contributing to stock declines, with some recent larger recuritments pushing the population higher in the past few years. The period with a higher frequency of high recruitments contributed to a large increase in stock biomass that subsequently declined throughout much of the 1970s forward. Less frequent large recruitments during the mid-1980s through 1990 slowed the rate of stock decline, with another series of large recruitments during 1999 and 2000 leading to a leveling off in the stock decline. The above-average cohorts from 2008, 2013, 2015, and 2016 are contributing to an increasing spawning stock size (Table \@ref(tab:recrES) and Figures \@ref(fig:es-recruits) and \@ref(fig:es-rec-devs)). Near the end of the time series, in 2020 and 2021, two recruitment events that are estimated to be greater than any other recruitment across the modeled period (Table \@ref(tab:recrES) and Figure \@ref(fig:es-rec-devs)).

\input{52tables/c_Recr_ES.tex}

```{r, results = "asis"}
sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "ts11_Age-0_recruits_(1000s)_with_95_asymptotic_intervals.png"
  ),
  caption = "Estimated time series of age-0 recruits (1000s) for the base model with 95 percent intervals.",
  alt_caption = "",
  label = "es-recruits"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "recdevs2_withbars.png"
  ),
  caption = "Estimated time series of recruitment deviations.",
  alt_caption = "",
  label = "es-rec-devs"
)
```

\newpage

## Exploitation status{-}

Replace text with
total catch divided by exploitable biomass or SPR harvest rate.
Include Table for last 10 years.
Include Figure with trend in f relative to target vs. trend in biomass relative to the target.

Table \@ref(tab:exploitES)

\input{52tables/d_SPR_ES.tex}


```{r, results = "asis"}
sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "SPR3_ratiointerval.png"
  ),
  caption = "Time series of SPR ratio: (1-SPR)/(1-SPR 45%).",
  alt_caption = "",
  label = "es-1-spr"
)

```

\newpage

## Ecosystem considerations{-}

Replace text with
a summary of reviewed environmental and ecosystem factors that appear to be correlated with stock dynamics.
These may include variability in they physical environment, habitat, competitors, prey, or predators that directly or indirectly affects the stock's status, vital rates (growth, survival, productivity/recruitment) or range and distribution.
Note which, if any, ecosystem factors are used in the assessment and how (e.g., as background information, in data preparations, as data inputs, in decisions about model structure).

## Reference points{-}

The estimated 2023 spawning biomass relative to unfished equilibrium spawning biomass is `r round(100*model[["current_depletion"]], 2)` percent, well above the management target of 40 percent of unfished spawning output. The fishing intensity has been at or below the current management harvest rate limit (spawning potential ratio [SPR], $\text{SPR}_{45\%}$) since the mid 1980s and declining in the last ten years (Figure \@ref(fig:es-spr)).  The relative biomass compared to the ratio of the estimated SPR to the management target ($\text{SPR}_{45\%}$) across all model years are shown in Figure \@ref(fig:es-phase) where warmer colors (red) represent early years and colder colors (blue) represent recent years. The relative biomass and estimated SPR has been well above the-es) shows the equilibrium curve based on a steepness value fixed at `r round(model$parameters[model$parameters$Label == "SR_BH_steep","Value"], 2)` with vertical dashed lines to indicate the estimate of fraction unfished at the start of `r endyr +1` (current) and the estimated management targets calculated based on the relative target biomass (B target), the SPR target, and the maximum sustainable yield (MSY).

Reerence points were calculated using the estimated selectivities and catch distributions among fleets in the most recent year of the model, `r endyr` (Table XX). Sustainable total yield, landings plus discards, using an $\text{SPR}_{45\%}$ is `r format(model$derived_quants[model$derived_quants$Label == "Dead_Catch_SPR", "Value"], scientific = FALSE, big.mark = ",")` mt. The spawning biomass equivalent to 40 percent of the unfished spawning biomass ($\text{SB}_{40\%}$) calculated using the SPR target ($\text{SPR}_{45\%}$) was `r format(model$derived_quants[model$derived_quants$Label == "SSB_SPR", "Value"],  scientific = FALSE, big.mark = ",")` mt. 

Table \@ref(tab:referenceES)

\input{52tables/e_ReferencePoints_ES.tex}

```{r, results = "asis"}

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "SPR4_phase.png"
  ),
  caption = "Phase plot of biomass ratio vs. SPR ratio.
Each point represents the biomass ratio at the start of the year and the relative fishing intensity in that same year. Warmer colors (red) represent early years and colder colors (blue) represent recent years. Lines through the final point show 95% intervals based on the asymptotic uncertainty for each dimension.",
  alt_caption = "",
  label = "es-phase"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "yield2_yield_curve_with_refpoints.png"
  ),
  caption = "Yield curve with reference points.",
  alt_caption = "",
  label = "es-yield"
)
```

\newpage

## Management performance{-}

Include Table of most recent 10 years of
catches in comparison with OFL, ABC, HG, and OY/ACL values,
overfishing levels,
actual catch and discard.
Include OFL (encountered), OFL (retained), and OFL (dead) if different due to discard and discard mortality.

Table \@ref(tab:es-manage)

```{r, tables-management-es, results = "asis"}
# Yes I know this code will likely make your eye twitch... sorry
tab <- cbind(utils::read.csv(here::here("data-processed", "harvest_spex.csv")) |>
  dplyr::filter(AREA_NAME == "CW" & YEAR %in% c(2013:2022) & PECIFICATION_TYPE == "OFL") |>
  dplyr::reframe(
    Year = YEAR,
    OFL = round(VAL, 1)
  ),
  utils::read.csv(here::here("data-processed", "harvest_spex.csv")) |>
  dplyr::filter(AREA_NAME == "CW" & YEAR %in% c(2013:2022) & PECIFICATION_TYPE == "ACL") |>
  dplyr::reframe(
    ACL = round(VAL, 1)
  ))
  
ts <- model$timeseries[model$timeseries$Yr %in% (endyr-9):endyr, 
                        c("Yr", "retain(B):_1", "retain(B):_2", "dead(B):_1", "dead(B):_2")]
df <- data.frame(
  Landings =  ts[, "retain(B):_1"] + ts[, "retain(B):_2"],
  Catch = ts[, "dead(B):_1"] + ts[, "dead(B):_2"]
)
out <- cbind(tab, df)

sa4ss::table_format(
  x = out,
  caption = "The  OFL (mt), ACL (mt), landings (mt) and estimated catch (mt) between 2013-2022.",
  label = "es-manage",
  align = "l",
  col_names = c("Year", "OFL", "ACL", "Landings", "Catch")
)
```

## Unresolved problems and major uncertainties{-}

```{r, echo=FALSE, results="asis"}
filein = fs::path(here::here("assessment", "shared_text","unresolved_uncertanties.Rmd"))
sa4ss::read_child(filein)
```


## Decision table and projections{-}

The projection of stock biomass, status, and harvest limits was developed using the base model. The total catches in 2023 and 2024 were set at 9,118 and 8,359 mt, respectively, based on recommendations from the Groundfish Management Team (GMT). The ABC values were estimated using a category 1 time-varying $\sigma_y$ starting at 0.50 combined with a P* value of 0.45. The catches during the projection period, 2025 - 2034 were set equal to the year-specific ABC (Table \@ref(tab:projection-es)). The spawning biomass and fraction unfished increase sharply during the projection due to the estimated large recruitments in 2020 and 2021 maturing and entering the spawning population, resulting in future OFLs and ABCs that are substantially higher than those set for 2023-24.

```{r, tables-projection-es, results = "asis"}
# Yes I know this code will likely make your eye twitch... sorry
tab <- cbind(utils::read.csv(here::here("data-processed", "harvest_spex.csv")) |>
  dplyr::filter(AREA_NAME == "CW" & YEAR >= 2023 & PECIFICATION_TYPE == "OFL") |>
  dplyr::reframe(
    Year = c(YEAR, 2025:2034),
    `Adopted OFL` = c(round(VAL, 1), rep("-", 10))
  ),
  utils::read.csv(here::here("data-processed", "harvest_spex.csv")) |>
  dplyr::filter(AREA_NAME == "CW" & YEAR >= 2023 & PECIFICATION_TYPE == "ACL") |>
  dplyr::reframe(
    `Adopted ACL` = c(round(VAL, 1), rep("-", 10))
  ))
  
x <- model[["timeseries"]] |>
  dplyr::reframe(
    Year = Yr,
    `Assumed Removals` = round(rowSums(dplyr::across(dplyr::starts_with("dead(B)"))), 1),
    ABC = round(rowSums(dplyr::across(dplyr::starts_with("dead(B)"))), 1),
    `Spawning Biomass` = round(SpawnBio, 1),
    `Fraction Unfished` = round(`Spawning Biomass`/`Spawning Biomass`[1],3)
  ) |>
  dplyr::filter(Year > endyr)

x[x$Year > 2024, "Assumed Removals"] <- "-"
x[x$Year %in% 2023:2024, "ABC"] <- "-"
OFL <- round(model$derived_quants[model$derived_quants$Label %in% paste0("OFLCatch_", 2023:2034), "Value"], 1) 
OFL[1:2] <- "-"
out <- cbind(tab, x[, "Assumed Removals"], OFL, x[,c(-1, -2)])
colnames(out)[4] <- "Assumed Removals"

sa4ss::table_format(
  x = out,
  caption = "The adopted OFL (mt), ACL (mt), and assumed removals (mt) in 2023-24 and the projected OFL (mt), ABC (mt), spawning biomass, and fraction unfished for 2025-2034.",
  label = "projection-es",
  align = "l"
)
```

## Scientific uncertainty{-}

```{r, echo=FALSE, results="asis"}
filein = fs::path(here::here("assessment", "shared_text","scientific_uncertainty.Rmd"))
sa4ss::read_child(filein)
```

## Research and data needs{-}

Please refer to the 2019 benchmark assessment for a detailed list of research and data needs for `r spp` [@haltuch_status_2019b].

