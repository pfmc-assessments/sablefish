\clearpage

\floatplacement{figure}{H}

# Figures

## Data

```{r, figures-data-summary, results = "asis"}
sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "data_plot.png"
  ),
  caption = "Summary of data sources used in the base model.",
  alt_caption = "",
  label = "data-summary"
)
```


```{r, figures-data-landings, results = "asis"}
sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "catch2 landings stacked.png"
  ),
  caption = "Landings by year from the fixed gear (FIX) and trawl (TWL) fleets.",
  alt_caption = "",
  label = "data-landings"
)
```


### Fishery-Independent Data

```{r figures-data-survey-wcgbt, results = "asis"}
sa4ss::add_figure(
  filein = fs::path(
    here::here(),
    figure_dir,
    "data_survey_wcgbt_proportion-by-depth.png"
  ),
  caption = glue::glue("The proportion of positive tows that observe {spp} in the \\glsentrylong{{s-wcgbt}} across depths sampled."),
  alt_caption = glue::glue("Approximately 25 percent of tows include {spp} at the shallowest depths sampled between 50--100 m with the percent positive tows increasing to 75 percent by 300 m. The highest percent positive tows occurs between 950--1,050 m with {spp} observed in greater than 95 percent of tows. The percent positive tows slowly declines to approximatley 60 percent at the maximum depth, 1,280 m, sampled."),
  label = "data-survey-wcgbt-proportion-by-depth"
)

sa4ss::add_figure(
  filein = fs::path(
    here::here(),
    figure_dir,
    "data_survey_wcgbt_presence-by-lat.png"
  ),
  caption = glue::glue("The proportion of positive tows that observe {spp} in the \\glsentrylong{{s-wcgbt}} by latitude."),
  alt_caption = glue::glue("Approximately 70--75 percent of tows include {spp} in Oregon and Washington. In California north of Point Conception, approximately 70 percent of the tows include {spp}, except around Point Reyes where the pecentage declines to between 60--70 percent. South of Point Conception in California, 25--45 percent of tows include {spp}."),
  label = "data-survey-wcgbt-proportion-by-latitude"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "index1_cpuedata_NWCBO.png"
  ),
  caption = "Annual relative index of abundance for the \\glsentrylong{s-wcgbt}.",
  alt_caption = "",
  label = "data-survey-wcgbt-index"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "comp_lendat_flt7mkt0.png"
  ),
  caption = "Annual length-composition data for the \\glsentrylong{s-wcgbt}.",
  alt_caption = "",
  label = "data-survey-wcgbt-lengths"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "comp_gstagedat_bubflt7mkt0.png"
  ),
  caption = "Annual age-composition data for the \\glsentrylong{s-wcgbt}.",
  alt_caption = "",
  label = "data-survey-wcgbt-ages"
)

sa4ss::add_figure(
  filein = fs::path(
    here::here(),
   figure_dir,
    "data_survey_wcgbt_young-length-by-year.png"
  ),
  caption = "The length distribution of age-0 and age-1 fish by survey pass across years sampled by the \\glsentrylong{s-wcgbt}. Blue dots indicate the lengths observed for each age and by pass.",
  alt_caption = "The distribution of lengths of age-0 fish, generally 30 cm or less, with the majority of age-0 fish being observed during pass 2 of the survey. Age-0 fish generally range between 30--45 cm in size with pass 2 observing larger age-1 fish compared to pass 1. Age-1 fish observed in 2021 and 2022 have a wide distribution of observed sizes between 25--45 cm.",
  label = "data-survey-wcgbt-young-length-by-year"
)

# sa4ss::add_figure(
#   filein = fs::path(
#     here::here(),
#     figure_dir,
#     "data_survey_wcgbt_sex-by-depth.png"
#   ),
#   caption = glue::glue("The proportion of {spp} by sex observed by the \\glsentrylong{{s-wcgbt}} across depths sampled.",
#   alt_caption = glue::glue("Observations of female {spp} are 50 percent or slightly greater between 150--400 m, with males being observed greater than 50 percent of the tows between 400--1,050 m. At the deepest depths sampled, between 1,050--1,280 m, females are observed in greater than 50 percent of the tows."),
#   label = "data-survey-wcgbt-sex-by-depth"
# )



```

```{r figures-discard-data, results = "asis"}
sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "discard_dataFIX.png"
  ),
  caption = "Annual \\glsentrylong{wcgop} discard rates for the fixed gear fleet.",
  alt_caption = "",
  label = "data-wcgop-discard-rates-fixed"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "discard_dataTWL.png"
  ),
  caption = "Annual \\glsentrylong{wcgop} discard rates for the trawl fleet.",
  alt_caption = "",
  label = "data-wcgop-discard-rates-trawl"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "bodywt_data_fltFIX.png"
  ),
  caption = "Annual \\glsentrylong{wcgop} mean weights of discarded fish for the fixed gear fleet.",
  alt_caption = "",
  label = "data-wcgop-discard-wghts-fixed"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "bodywt_data_fltTWL.png"
  ),
  caption = "Annual \\glsentrylong{wcgop} mean weights of discarded fish for the trawl fleet.",
  alt_caption = "",
  label = "data-wcgop-discard-wghts-trawl"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "comp_lendat_flt1mkt1.png"
  ),
  caption = "Annual distribution of observed discarded fish by length in \\glsentrylong{wcgop} data for the fixed gear fleet.",
  alt_caption = "",
  label = "data-wcgop-discard-len-fixed"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "comp_lendat_flt2mkt1.png"
  ),
  caption = "Annual distribution of observed discarded fish by length in \\glsentrylong{wcgop} data for the trawl fleet.",
  alt_caption = "",
  label = "data-wcgop-discard-len-trawl"
)
```

## Model Results

### Bridging



### Estimated Biology

### Selectivity

### Recruitment

### Fits to Data

### Time series

### Sensitivity Analyses and Retrospectives

```{r figures-sensitivity, results = "asis"}
ignore <- fs::dir_ls(
  fs::path(dirname(model_location), "sensitivities"),
  type = "file",
  regex = "compare1_|compare3"
) |>
  tibble::as_tibble_col(column_name = "filein") |>
  dplyr::mutate(
    label = paste("sensitivity", gsub("\\.png", "", basename(filein)), sep = "-"),
    type = dplyr::case_when(
      grepl("1|2", basename(filein)) ~ "Spawning output",
      grepl("3|4", basename(filein)) ~ "Fraction unfished"
    ),
    caption = glue::glue(
      "{type} across a range of sensitivity analyses and the base model."
    )
  ) |>
    dplyr::select(filein, caption, label) |>
    purrr::pmap(.f = sa4ss::add_figure)
```

```{r figures-retro, results = "asis"}
info <- read.csv(
  file = fs::dir_ls(
    dirname(model_location),
    regexp = "retrofigures4doc.csv",
    recurse = TRUE
  )
) |>
  dplyr::mutate(
    filein = gsub(
      paste0(".+", basename(here::here())),
      here::here(),
      filein
    ),
  ) |>
    purrr::pmap(.f = sa4ss::add_figure)
```

```{r figures-historical-make, cache = TRUE}
model_historical <- c(
  purrr::map(
    .x = head(fs::path(
      fs::dir_ls(
        fs::path(here::here(), "models"),
        type = "directory"
      ),
      "base",
      "base"
    ), -1),
    .f = r4ss::SS_output,
    verbose = FALSE,
    printstats = FALSE,
    covar = FALSE,
    compfile = NULL,
    NoCompOK = TRUE,
    wtfile = "",
    readwt = FALSE
  ),
  list(model)
)
names(model_historical) <- fs::dir_ls(
  fs::path(here::here(), "models"),
  type = "directory"
) |> basename()

```{r figures-historical, results = "asis"}
r4ss::SSplotComparisons(
  r4ss::SSsummarize(c(model_historical, list(model)), verbose = FALSE),
  plotdir = "53Figures",
  subplots = c(2, 4),
  print = TRUE,
  plot = FALSE,
  legendlabels = names(model_historical),
  filenameprefix = "historical_"
)
sa4ss::add_figure(
  fs::path("53Figures", "historical_compare2_spawnbio_uncertainty.png"),
  caption = glue::glue("Comparisons of spawning biomass (mt) between the current assessment and recent benchmark and update assessments since {min(names(model_historical))}."),
  alt_caption = "All trajectories of spawning biomass from the most recent assessments are encapsulated within the estimated uncertainty from the current model.",
  label = "historical-model-comparison-sb"
)
sa4ss::add_figure(
  fs::path("53Figures", "historical_compare4_Bratio_uncertainty.png"),
  caption = glue::glue("Comparisons of fraction unfished between the current assessment and recent benchmark and update assessments since {min(names(model_historical))}."),
  alt_caption = "All trajectories of fraction unfished from the most recent assessments are encapsulated within the estimated uncertainty from the current model.",
  label = "historical-model-comparison-unfished"
)
```

### Likelihood Profiles

```{r figures-profiles, results = "asis"}
ignore <- tidyr::expand_grid(
  folder_list = fs::dir_ls(dirname(model_location), regexp = "base_profile"),
  string = c("compare1", "compare3", "piner")
) |>
  dplyr::mutate(
    filein = purrr::map2_chr(
      .x = folder_list,
      .y = string,
      .f = ~ fs::dir_ls(path = .x, regexp = .y)
    ),
    parameter = edit_string(
      sub("base_profile_", "", basename(names(folder_list)))
    ),
    label = paste("profile", gsub(" ", "-", parameter), string, sep = "-"),
    type = dplyr::case_when(
      grepl("piner", string) ~ "negative log-likelihood",
      grepl("1", string) ~ "spawning output",
      grepl("3", string) ~ "fraction unfished"
    ),
    caption = glue::glue(
      "Change in the {type} across a range of {parameter} values."
    )
  ) |>
    dplyr::select(filein, caption, label) |>
    purrr::pmap(.f = sa4ss::add_figure)
```

## Reference Points and Projections

```{r figures-reference-points, results = "asis"}
sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "SPR3_ratiointerval.png"
  ),
  caption = "Timeseries of SPR ratio: (1-SPR)/(1-SPR 45%).",
  alt_caption = "",
  label = "model-spr"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "SPR4_phase.png"
  ),
  caption = "Phase plot of biomass ratio vs. SPR ratio.
Each point represents the biomass ratio at the start of the year and the relative fishing intensity in that same year. Warmer colors (red) represent early years and colder colors (blue) represent recent years. Lines through the final point show 95% intervals based on the asymptotic uncertainty for each dimension.",
  alt_caption = "",
  label = "model-phase"
)

sa4ss::add_figure(
  filein = fs::path(
    model_location,
    "plots",
    "yield2_yield_curve_with_refpoints.png"
  ),
  caption = "Yield curve with reference points.",
  alt_caption = "",
  label = "model-yield"
)
```